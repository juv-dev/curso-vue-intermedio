name: Bump Version

on:
  pull_request:
    branches: [main]
    types: [opened, reopened, ready_for_review, synchronize]

jobs:
  bump-version:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Debug Info
        run: |
          echo "PR Head Ref: ${{ github.head_ref }}"
          echo "Base Ref: ${{ github.base_ref }}"
          echo "Event Action: ${{ github.event.action }}"

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get next version
        id: version
        run: |
          # Get current version
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: ${CURRENT_VERSION}"
          
          # Increment patch version
          IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT_VERSION"
          PATCH_VERSION=$((VERSION_PARTS[2] + 1))
          NEXT_VERSION="${VERSION_PARTS[0]}.${VERSION_PARTS[1]}.${PATCH_VERSION}"
          
          echo "version=${NEXT_VERSION}" >> $GITHUB_OUTPUT
          echo "Next version: ${NEXT_VERSION}"

      - name: Update version
        run: |
          # Get PR head ref
          PR_HEAD_REF="${{ github.head_ref || github.event.pull_request.head.ref }}"
          echo "PR Head Ref: $PR_HEAD_REF"
          
          # Update version in package.json
          npm pkg set version="${{ steps.version.outputs.version }}"
          echo "Updated version to: ${{ steps.version.outputs.version }}"
          
          # Configure git
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          
          # Commit changes
          git add package.json
          git commit -m "feat: bump version to ${{ steps.version.outputs.version }} [skip ci]"
          
          # Push changes to PR branch
          git push origin "HEAD:refs/heads/$PR_HEAD_REF"

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `âœ… Version updated to \`${{ steps.version.outputs.version }}\` in this PR.` 
              })
            } catch (error) {
              console.error('Error commenting on PR:', error)
            }