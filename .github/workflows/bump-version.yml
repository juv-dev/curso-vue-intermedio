name: Bump Version

on:
  pull_request:
    branches: [ main ]
    types: [opened, reopened, ready_for_review, synchronize]

jobs:
  bump-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Obtener siguiente versión
        id: version
        run: |
          # Obtiene la versión actual
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Versión actual: ${CURRENT_VERSION}"
          
          # Incrementa el patch version (1.0.1 -> 1.0.2)
          IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT_VERSION"
          PATCH_VERSION=$((VERSION_PARTS[2] + 1))
          NEXT_VERSION="${VERSION_PARTS[0]}.${VERSION_PARTS[1]}.${PATCH_VERSION}"
          
          echo "version=${NEXT_VERSION}" >> $GITHUB_OUTPUT
          echo "Siguiente versión: ${NEXT_VERSION}"

      - name: Actualizar versión
        run: |
          # Obtener el nombre de la rama del PR
          PR_HEAD_REF=$(jq --raw-output .pull_request.head.ref "$GITHUB_EVENT_PATH")
          echo "Rama del PR: $PR_HEAD_REF"
          
          # Actualiza package.json
          npm version ${{ steps.version.outputs.version }} --no-git-tag-version
          echo "Versión actualizada: ${{ steps.version.outputs.version }}"
          
          # Configura git
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          
          # Hace commit de los cambios
          git add package.json
          git commit -m "feat: bump version to ${{ steps.version.outputs.version }} [skip ci]"
          
          # Hace push de los cambios a la rama del PR
          git push origin "HEAD:refs/heads/$PR_HEAD_REF"

      - name: Comentar en el PR
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `✅ Versión actualizada a \`${{ steps.version.outputs.version }}\` en este PR.` 
            })