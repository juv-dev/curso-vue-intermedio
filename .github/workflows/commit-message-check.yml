name: Check Commit Message
on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, edited]

jobs:
  validate-commit-message:
    name: Validar Mensajes de Commit
    runs-on: ubuntu-latest
    
    # Skip validation for bots and scheduled runs
    if: |
      !(
        github.actor == 'dependabot[bot]' || 
        github.actor == 'actions-bot' || 
        github.actor == 'github-actions[bot]' ||
        github.event_name == 'schedule'
      )
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install commitlint
        run: npm install -g @commitlint/cli @commitlint/config-conventional --no-package-lock

      - name: Validate PR title
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          # Check if PR title is empty
          if [ -z "$PR_TITLE" ]; then
            echo "::error::PR title cannot be empty"
            exit 1
          fi

          # Skip validation on retries
          if [[ "${{ github.run_attempt }}" -gt 1 ]]; then
            echo "⚠️  Warning: Skipping validation on attempt #${{ github.run_attempt }}"
            exit 0
          fi

          # Create temporary config file
          cat > commitlint.config.js << 'EOL'
          module.exports = {
            extends: ['@commitlint/config-conventional'],
            rules: {
              'type-enum': [2, 'always', ['feat', 'fix']],
              'header-max-length': [2, 'always', 100],
              'scope-case': [2, 'always', 'kebab-case'],
              'subject-case': [0],
              'scope-empty': [0]
            }
          };
          EOL

          # Validate title
          echo "Validando: $PR_TITLE"
          echo "$PR_TITLE" | commitlint --edit -c commitlint.config.js || {
            echo "::error::❌ El título del PR debe seguir el formato: 'tipo(ámbito): descripción'"
            echo "Formatos válidos:"
            echo "- feat: descripción"
            echo "- feat(ámbito): descripción"
            echo "- fix: descripción"
            echo "- fix(ámbito): descripción"
            exit 1
          }

          echo "✅ El título del PR es válido"