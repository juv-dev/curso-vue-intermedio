name: Check Commit Message
on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, edited]

jobs:
  check-commit:
    name: Validate Commit Message
    runs-on: ubuntu-latest
    
    # Skip validation for bots and scheduled runs
    continue-on-error: ${{ 
      github.actor == 'dependabot[bot]' || 
      github.actor == 'actions-bot' || 
      github.actor == 'github-actions[bot]' ||
      github.event_name == 'schedule'
    }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '>=22.0.0'
          cache: 'npm'

      - name: Validate PR title
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          # Check if PR title is empty
          if [ -z "$PR_TITLE" ]; then
            echo "::error::PR title cannot be empty"
            exit 1
          fi

          # Skip validation on retries
          if [[ "${{ github.run_attempt }}" -gt 1 ]]; then
            echo "⚠️  Warning: Skipping validation on attempt #${{ github.run_attempt }}"
            exit 0
          fi

          # Install commitlint if not present
          if ! command -v commitlint &> /dev/null; then
            echo "Installing commitlint..."
            npm install -g @commitlint/cli @commitlint/config-conventional
          fi

          # Commitlint configuration
          CONFIG='{
            "extends": ["@commitlint/config-conventional"],
            "rules": {
              "type-enum": [2, "always", ["feat", "fix"]],
              "header-max-length": [2, "always", 100],
              "scope-case": [2, "always", "kebab-case"],
              "subject-case": [0],
              "scope-empty": [0]
            }
          }'

          # Validate title
          echo "Validating: $PR_TITLE"
          echo "$PR_TITLE" | npx commitlint --edit - --config="$CONFIG" || {
            echo "::error::❌ PR title must follow: 'type(scope): description'"
            echo "Valid formats:"
            echo "- feat: description"
            echo "- feat(scope): description"
            echo "- fix: description"
            echo "- fix(scope): description"
            exit 1
          }

          echo "✅ PR title is valid"