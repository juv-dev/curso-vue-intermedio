name: Version and Tag on Merge

on:
  push:
    branches:
      - main
    paths:
      - '**/package.json'
      - '!**/node_modules/**'

jobs:
  version-update:
    name: Update Version and Create Tag
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8
          run_install: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '>=22.0.0'
          cache: 'pnpm'

      - name: Find projects with package.json
        id: find-projects
        run: |
          projects=$(find . -name "package.json" -not -path "*/node_modules/*" -not -path "./.github/*" -exec dirname {} \; | sed 's|^\./||' | jq -R -s -c 'split("\n") | map(select(. != ""))')
          echo "projects=$projects" >> $GITHUB_OUTPUT
          echo "Found projects: $projects"

      - name: Process each project
        run: |
          for project in ${{ steps.find-projects.outputs.projects }}; do
            if [ -d "$project" ]; then
              echo "üîç Processing project: $project"
              cd "$project"
              
              if [ -f "package.json" ]; then
                # Obtener la versi√≥n actual
                CURRENT_VERSION=$(node -p "require('./package.json').version")
                echo "Current version: $CURRENT_VERSION"
                
                # Incrementar versi√≥n (ejemplo: incrementar patch)
                IFS='.' read -r major minor patch <<< "${CURRENT_VERSION//[^0-9.]/}"
                NEW_VERSION="$major.$minor.$((patch + 1))"
                echo "New version: $NEW_VERSION"
                
                # Actualizar el package.json
                pnpm version $NEW_VERSION --no-git-tag-version
                
                # Configurar Git
                git config --global user.name 'GitHub Actions'
                git config --global user.email 'actions@github.com'
                
                # Commit y tag
                git add package.json
                git commit -m "chore: bump version to $NEW_VERSION [skip ci]"
                git tag -a "v$NEW_VERSION" -m "Version $NEW_VERSION"
              else
                echo "‚ÑπÔ∏è No package.json found in $project"
              fi
              cd "$GITHUB_WORKSPACE"
            else
              echo "‚ö†Ô∏è Project directory not found: $project"
            fi
          done

      - name: Push changes and tags
        run: |
          git push origin main
          git push --tags