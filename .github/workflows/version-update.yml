name: Version and Tag on Merge

on:
  push:
    branches:
      - main
    paths:
      - '**/package.json'
      - '!**/node_modules/**'
      - '!**/.github/**'

jobs:
  version-update:
    name: Update Version and Create Tag
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8
          run_install: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '>=22.0.0'
          cache: 'pnpm'

      - name: Find projects with package.json
        id: find-projects
        run: |
          projects=$(find . -name "package.json" -not -path "*/node_modules/*" -not -path "./.github/*" -exec dirname {} \; | sed 's|^\./||' | jq -R -s -c 'split("\n") | map(select(. != ""))')
          echo "projects=$projects" >> $GITHUB_OUTPUT
          echo "Found projects: $projects"

      - name: Process each project
        run: |
          for project in ${{ steps.find-projects.outputs.projects }}; do
            if [ -d "$project" ]; then
              echo "üîç Processing project: $project"
              cd "$project"
              
              if [ -f "package.json" ]; then
                # Obtener la versi√≥n actual
                CURRENT_VERSION=$(node -p "require('./package.json').version")
                echo "Current version: $CURRENT_VERSION"
                
                # Incrementar versi√≥n (solo patch por ahora)
                IFS='.' read -r major minor patch <<< "${CURRENT_VERSION//[^0-9.]/}"
                NEW_VERSION="$major.$minor.$((patch + 1))"
                echo "New version: $NEW_VERSION"
                
                # Actualizar el package.json
                pnpm version $NEW_VERSION --no-git-tag-version
              else
                echo "‚ÑπÔ∏è No package.json found in $project"
                continue
              fi
              
              cd "$GITHUB_WORKSPACE"
            else
              echo "‚ö†Ô∏è Project directory not found: $project"
            fi
          done

      - name: Commit and tag changes
        run: |
          # Configurar Git
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          
          # Agregar todos los cambios
          git add .
          
          # Verificar si hay cambios para hacer commit
          if ! git diff --cached --quiet; then
            git commit -m "chore: bump versions [skip ci]"
            git push origin main
            echo "‚úÖ Changes pushed to main"
          else
            echo "‚ÑπÔ∏è No changes to commit"
          fi

          # Crear tags
          for project in ${{ steps.find-projects.outputs.projects }}; do
            if [ -d "$project" ] && [ -f "$project/package.json" ]; then
              cd "$project"
              VERSION=$(node -p "require('./package.json').version")
              git tag -a "v$VERSION" -m "Version $VERSION"
              cd "$GITHUB_WORKSPACE"
            fi
          done
          
          # Empujar tags
          git push --tags
          echo "‚úÖ Tags pushed"